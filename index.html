<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Plataforma da Olimpíada de Competições da Rede AutoPrime para lançamento e acompanhamento de métricas de performance.">
    <title>Olimpíada de Competições - Rede AutoPrime</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-primary: #0F172A; --color-secondary: #1E293B; --color-text-primary: #F8FAFC;
            --color-text-secondary: #94A3B8; --color-text-body: #334155; --color-accent: #2563EB;
            --color-accent-hover: #1D4ED8; --color-background: #F1F5F9; --color-surface: #FFFFFF;
            --color-highlight: #E0F2FE; --color-border: #CBD5E1; --color-success: #16A34A;
            --color-success-bg: #F0FDF4; --color-error: #DC2626; --color-error-bg: #FEF2F2;
            --color-error-link: #991B1B; --color-info: #3B82F6; --color-info-bg: #EFF6FF;
            --color-gold: #CA8A04; --color-gold-bg: #FEFCE8; --color-silver: #94A3B8;
            --color-silver-bg: #F1F5F9; --color-bronze: #A16207; --color-bronze-bg: #FEF9C3;
            --color-champion-bg: #FEFCE8; --color-champion-text: #B45309;
            --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-size-sm: 0.875rem; --font-size-base: 1rem; --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem; --font-size-2xl: 1.5rem; --font-size-3xl: 1.875rem;
            --space-1: 0.25rem; --space-2: 0.5rem; --space-3: 0.75rem; --space-4: 1rem;
            --space-6: 1.5rem; --space-8: 2rem; --border-radius: 0.5rem; --border-radius-lg: 0.75rem;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --transition: all 0.2s ease-in-out;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body { font-family: var(--font-family-sans); background-color: var(--color-background); color: var(--color-text-body); display: flex; flex-direction: column; align-items: center; line-height: 1.6; }
        .app-header { width: 100%; position: fixed; top: 0; left: 0; background-color: var(--color-primary); color: var(--color-text-primary); padding: var(--space-3) var(--space-4); z-index: 1000; box-shadow: var(--shadow-lg); display: none; }
        .app-header__container { width: 100%; max-width: 1280px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-4); }
        .app-header__brand { display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-size-lg); font-weight: 700; }
        .app-logo-img { height: 32px; width: auto; }
        .app-header__company-name { font-weight: 400; color: var(--color-text-secondary); border-left: 1px solid var(--color-text-secondary); padding-left: var(--space-3); margin-left: var(--space-2); }
        .app-header__nav { display: flex; align-items: center; gap: var(--space-1); flex-wrap: wrap; }
        .page-container { display: flex; justify-content: center; align-items: center; flex-grow: 1; width: 100%; padding: var(--space-4); padding-top: 100px; }
        .auth-container, .app-container { width: 100%; background-color: var(--color-surface); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-lg); padding: var(--space-6); }
        .auth-container { max-width: 420px; }
        .app-container { max-width: 896px; }
        .screen { display: none; }
        .screen.is-active { display: block; }
        .btn { display: inline-flex; justify-content: center; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-4); font-family: var(--font-family-sans); font-size: var(--font-size-base); font-weight: 600; border-radius: var(--border-radius); border: 1px solid transparent; cursor: pointer; transition: var(--transition); text-decoration: none; white-space: nowrap; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn:focus-visible { outline: 2px solid var(--color-accent); outline-offset: 2px; }
        .btn--primary { background-color: var(--color-primary); color: var(--color-text-primary); }
        .btn--primary:hover:not(:disabled) { background-color: var(--color-accent); }
        .btn--secondary { background-color: transparent; color: var(--color-text-body); border-color: var(--color-border); }
        .btn--secondary:hover:not(:disabled) { background-color: var(--color-background); border-color: var(--color-text-secondary); }
        .btn--success { background-color: var(--color-success); color: var(--color-text-primary); }
        .btn--danger { background-color: var(--color-error); color: var(--color-text-primary); }
        .btn--full { width: 100%; }
        .nav-btn { background: transparent; border: none; color: var(--color-text-secondary); padding: var(--space-2) var(--space-3); border-radius: var(--border-radius); font-size: var(--font-size-sm); font-weight: 600; }
        .nav-btn:hover { background-color: var(--color-secondary); color: var(--color-text-primary); }
        .nav-btn.is-active { background-color: var(--color-accent); color: var(--color-text-primary); }
        .form-group { margin-bottom: var(--space-4); }
        .form-label { display: block; font-size: var(--font-size-sm); font-weight: 600; margin-bottom: var(--space-2); }
        .form-input { width: 100%; padding: var(--space-2) var(--space-3); font-size: var(--font-size-base); border: 1px solid var(--color-border); border-radius: var(--border-radius); transition: var(--transition); }
        .form-input:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }
        .section-header { margin-bottom: var(--space-6); padding-bottom: var(--space-2); border-bottom: 1px solid var(--color-border); }
        .section-header__title { font-size: var(--font-size-2xl); font-weight: 800; color: var(--color-primary); }
        .message-box { padding: var(--space-3); margin-bottom: var(--space-4); border-radius: var(--border-radius); font-size: var(--font-size-sm); display: none; }
        .message-box.is-visible { display: block; }
        .message-box--error { background-color: var(--color-error-bg); color: var(--color-error); }
        .message-box--error a { color: var(--color-error-link); font-weight: bold; text-decoration: underline; }
        .message-box--success { background-color: var(--color-success-bg); color: var(--color-success); }
        .message-box--info { background-color: var(--color-info-bg); color: var(--color-info); }
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-top: 2px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        .spinner--dark { border-color: var(--color-border); border-top-color: var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-placeholder { text-align: center; color: var(--color-text-secondary); padding: var(--space-8); display: flex; flex-direction: column; align-items: center; gap: var(--space-4); }
        .auth-header { text-align: center; margin-bottom: var(--space-6); }
        .auth-logo-img { height: 40px; width: auto; margin: 0 auto var(--space-3); display: block; }
        .auth-header__title { font-size: var(--font-size-2xl); font-weight: 800; color: var(--color-primary); }
        .auth-header__subtitle { font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-1); }
        .launch-group { background-color: var(--color-highlight); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: var(--space-4); margin-bottom: var(--space-4); }
        .launch-grid { display: grid; gap: var(--space-4); }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.75); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.is-visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--color-surface); padding: var(--space-6); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-lg); width: 100%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.is-visible .modal-content { transform: scale(1); }
        .modal__title { font-size: var(--font-size-xl); font-weight: 700; color: var(--color-primary); margin-bottom: var(--space-2); }
        .modal__description { color: var(--color-text-secondary); margin-bottom: var(--space-4); }
        .modal__review-box { background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: var(--space-4); margin-bottom: var(--space-6); font-size: var(--font-size-sm); line-height: 1.8; }
        .modal__actions { display: flex; justify-content: flex-end; gap: var(--space-3); }
        .history-item { padding: var(--space-4); border: 1px solid var(--color-border); border-radius: var(--border-radius); transition: var(--transition); }
        .history-item:hover { background-color: var(--color-highlight); }
        .history-item__header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2); }
        .history-item__title { font-size: var(--font-size-lg); font-weight: 700; color: var(--color-primary); }
        .history-item__meta { font-size: var(--font-size-sm); color: var(--color-secondary); }
        .history-item__details { font-size: var(--font-size-sm); color: var(--color-text-secondary); list-style-position: inside; padding-left: var(--space-1); }
        .ranking-sections { display: grid; gap: var(--space-6); }
        .champion-card { padding: var(--space-6); background-color: var(--color-champion-bg); border: 2px solid var(--color-primary); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-xl); text-align: center; margin-bottom: var(--space-8); }
        .champion-card__title { font-size: var(--font-size-xl); font-weight: 800; color: var(--color-primary); display: flex; align-items: center; justify-content: center; gap: var(--space-2); }
        .champion-card__company-name { font-size: var(--font-size-2xl); font-weight: 800; color: var(--color-primary); margin-top: var(--space-2); }
        .ranking-card { background-color: var(--color-surface); padding: var(--space-4); border-radius: var(--border-radius-lg); box-shadow: var(--shadow); border: 1px solid var(--color-border); }
        .ranking-card__title { font-size: var(--font-size-xl); font-weight: 700; color: var(--color-primary); margin-bottom: var(--space-4); }
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); margin-bottom: var(--space-2); border-radius: var(--border-radius); font-weight: 600; border-left: 5px solid; }
        .ranking-item:last-child { margin-bottom: 0; }
        .ranking-item--gold { background-color: var(--color-gold-bg); border-color: var(--color-gold); }
        .ranking-item--silver { background-color: var(--color-silver-bg); border-color: var(--color-silver); }
        .ranking-item--bronze { background-color: var(--color-bronze-bg); border-color: var(--color-bronze); }
        @media (min-width: 640px) { .launch-grid, .ranking-sections { grid-template-columns: repeat(2, 1fr); } .launch-grid__full-width { grid-column: 1 / -1; } }
        @media (min-width: 1024px) { .ranking-sections { grid-template-columns: repeat(3, 1fr); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header id="app-header" class="app-header">
        <div class="app-header__container">
            <div class="app-header__brand" role="banner">
                <img src="Rede Auto Prime II.png" alt="Logo Rede AutoPrime" class="app-logo-img">
                Olimpíada <span id="header-empresa-name" class="app-header__company-name"></span>
            </div>
            <nav class="app-header__nav" aria-label="Navegação principal"><button data-screen="lanca" class="nav-btn">Lançamentos</button><button data-screen="historico" class="nav-btn">Meu Histórico</button><button data-screen="ranking" class="nav-btn">Ranking</button><button id="logout-button" class="btn btn--danger" style="padding: var(--space-1) var(--space-3); font-size: var(--font-size-sm);">Sair</button></nav>
        </div>
    </header>

    <main class="page-container">
        <section id="login-container" class="auth-container">
            <header class="auth-header">
                <img src="Rede Auto Prime II.png" alt="Logo Rede AutoPrime" class="auth-logo-img">
                <h1 class="auth-header__title">Olimpíada - Acesso</h1>
            </header>
            <form id="login-form" novalidate>
                <div class="form-group"><label for="username" class="form-label">Usuário</label><input type="text" id="username" name="username" required class="form-input" placeholder="Seu nome de usuário"></div>
                <div class="form-group"><label for="password" class="form-label">Senha</label><input type="password" id="password" name="password" required class="form-input" placeholder="Sua senha secreta"></div>
                <div id="login-message-box" class="message-box" role="alert"></div>
                <button type="submit" id="login-button" class="btn btn--primary btn--full"><span id="login-button-text">Entrar</span><div id="login-spinner" class="spinner hidden" aria-label="Carregando"></div></button>
            </form>
        </section>

        <section id="registration-form" class="auth-container hidden">
            <header class="auth-header">
                <img src="Rede Auto Prime II.png" alt="Logo Rede AutoPrime" class="auth-logo-img">
                <h1 class="auth-header__title">Cadastro Olimpíada</h1><p class="auth-header__subtitle">Preencha os dados da sua empresa para participar.</p>
            </header>
            <form id="reg-form" novalidate>
                <div class="form-group"><label for="empresaName" class="form-label">Nome da Empresa:</label><input type="text" id="empresaName" name="empresaName" required class="form-input"></div>
                <div class="form-group"><label for="managerName" class="form-label">Nome do Gestor/Supervisor:</label><input type="text" id="managerName" name="managerName" required class="form-input"></div>
                <div class="form-group"><label for="whatsappNumber" class="form-label">WhatsApp (com DDD):</label><input type="tel" id="whatsappNumber" name="whatsappNumber" required pattern="[0-9]{10,11}" class="form-input" placeholder="Ex: 84999998888"></div>
                <div class="form-group"><label for="carGoal" class="form-label">Meta de carros entregues:</label><input type="number" id="carGoal" name="carGoal" required min="1" class="form-input" placeholder="Ex: 50"></div>
                <div id="reg-message-box" class="message-box" role="alert"></div>
                <button type="submit" id="save-button" class="btn btn--success btn--full">Salvar Informações</button>
            </form>
        </section>

        <article id="app-main-content" class="app-container hidden">
            <section id="screen-lanca" class="screen">
                <header class="section-header"><h2 class="section-header__title">Lançamento Diário de Competições</h2></header>
                <form id="lanca-form" novalidate>
                    <div class="form-group"><label for="lanca-date" class="form-label">Data do Lançamento (Dia dos Fatos):</label><input type="date" id="lanca-date" name="lanca-date" required class="form-input"></div>
                    <h3 class="section-header__title" style="font-size: var(--font-size-xl); margin-top: var(--space-8);">Modalidades</h3>
                    <div class="launch-group"><label for="produtividade-entregues" class="form-label"><strong>Produtividade:</strong> Digite a quantidade de carros entregues <strong>no dia selecionado</strong></label><input type="number" id="produtividade-entregues" name="produtividade-entregues" required min="0" placeholder="Ex: 10" class="form-input"></div>
                    <div class="launch-group"><label for="ticket-medio-mo" class="form-label"><strong>Ticket Médio:</strong> Digite o valor do ticket médio de M.O. dos carros de seguro <strong>deste mês</strong> (Valor R$)</label><input type="number" id="ticket-medio-mo" name="ticket-medio-mo" required min="0" step="0.01" placeholder="Ex: 1500.50" class="form-input"></div>
                    <div class="launch-group">
                        <h4 class="form-label" style="font-size: 1rem;"><strong>Venda Agregada:</strong></h4>
                        <label for="venda-seguro-abertos" class="form-label" style="font-weight: 400; font-size: var(--font-size-sm);">Carros de seguro que abriram O.S. <strong>no dia</strong>.</label><input type="number" id="venda-seguro-abertos" name="venda-seguro-abertos" required min="0" placeholder="Total de carros de seguro" class="form-input" style="margin-bottom: var(--space-4);">
                        <label for="venda-agregada-fechados" class="form-label" style="font-weight: 400; font-size: var(--font-size-sm);">Desses, quantos fecharam venda agregada <strong>no dia</strong>.</label><input type="number" id="venda-agregada-fechados" name="venda-agregada-fechados" required min="0" placeholder="Carros com venda agregada" class="form-input">
                    </div>
                    <h3 class="section-header__title" style="font-size: var(--font-size-xl); margin-top: var(--space-8);">Estabilidade por Setor (Finalizados no Dia)</h3>
                    <div class="launch-grid">
                        <div class="form-group"><label for="estabilidade-funilaria" class="form-label">Funilaria:</label><input type="number" id="estabilidade-funilaria" name="estabilidade-funilaria" required min="0" placeholder="Carros" class="form-input"></div>
                        <div class="form-group"><label for="estabilidade-preparacao" class="form-label">Preparação:</label><input type="number" id="estabilidade-preparacao" name="estabilidade-preparacao" required min="0" placeholder="Carros" class="form-input"></div>
                        <div class="form-group"><label for="estabilidade-pintura" class="form-label">Pintura:</label><input type="number" id="estabilidade-pintura" name="estabilidade-pintura" required min="0" placeholder="Carros" class="form-input"></div>
                        <div class="form-group"><label for="estabilidade-montagem" class="form-label">Montagem:</label><input type="number" id="estabilidade-montagem" name="estabilidade-montagem" required min="0" placeholder="Carros" class="form-input"></div>
                        <div class="form-group launch-grid__full-width"><label for="estabilidade-polimento" class="form-label">Polimento:</label><input type="number" id="estabilidade-polimento" name="estabilidade-polimento" required min="0" placeholder="Carros" class="form-input"></div>
                    </div>
                    <div id="lanca-message-box" class="message-box" role="alert"></div>
                    <button type="submit" class="btn btn--primary btn--full" style="margin-top: var(--space-4);">Conferir e Lançar Dados</button>
                </form>
            </section>
            <section id="screen-historico" class="screen">
                <header class="section-header" style="display: flex; justify-content: space-between; align-items: center;"><h2 class="section-header__title">Meu Histórico</h2><button id="refresh-history-button" class="btn btn--secondary">Atualizar</button></header>
                <div id="historico-loading" class="loading-placeholder hidden"><div class="spinner spinner--dark"></div><span>Carregando histórico...</span></div>
                <div id="historico-list"></div><p id="historico-empty" class="hidden">Nenhum lançamento encontrado.</p><div id="historico-message-box" class="message-box" role="alert"></div>
            </section>
            <section id="screen-ranking" class="screen">
                <header class="section-header"><h2 class="section-header__title">Ranking Geral</h2></header>
                <div id="ranking-loading" class="loading-placeholder hidden"><div class="spinner spinner--dark"></div><span>Calculando Ranking...</span></div>
                <div id="campeao-geral-container" class="champion-card hidden"><h3 class="champion-card__title"><span class="icon" aria-hidden="true">👑</span> CAMPEÃO GERAL</h3><div id="campeao-geral-details"></div></div>
                <div id="ranking-container" class="ranking-sections"></div><div id="ranking-message-box" class="message-box" role="alert"></div>
            </section>
        </article>
    </main>
    <div id="lanca-confirm-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-labelledby="modal-title" aria-modal="true">
            <h3 id="modal-title" class="modal__title">Confirmação de Lançamento</h3><p class="modal__description">Confira os dados antes de salvar. Lançamentos não podem ser editados.</p>
            <div id="lanca-data-review" class="modal__review-box"></div>
            <div class="modal__actions"><button id="modal-cancel-button" class="btn btn--secondary">Voltar</button><button id="modal-confirm-button" class="btn btn--success">Confirmar</button></div>
        </div>
    </div>
    
    <script type="module">
        // Importações dos Módulos Firebase via CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, setDoc, doc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- Configuração e Estado Global ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const COLLECTIONS = { REGISTRATION: 'CadastroOlimpiada', LOGIN: 'LoginSenhaPOP', LAUNCHES: 'LancaOlimpiada' };
        const ESTABILIDADE_FIELDS = ['estabilidadeFunilaria', 'estabilidadePreparacao', 'estabilidadePintura', 'estabilidadeMontagem', 'estabilidadePolimento'];
        const MODALITY_WEIGHTS = { produtividadeScore: 3, ticketMedioScore: 3, vendaAgregadaScore: 3, estabilidadeFunilaria: .5, estabilidadePreparacao: .5, estabilidadePintura: .5, estabilidadeMontagem: .5, estabilidadePolimento: .5 };
        let db, auth;
        const appState = { userId: null, empresaName: '', carGoal: 0, managerName: '', dailyLaunchData: {} };

        // --- Seletores de DOM ---
        const DOMElements = {
            header: document.getElementById('app-header'), headerEmpresaName: document.getElementById('header-empresa-name'), loginContainer: document.getElementById('login-container'),
            registrationContainer: document.getElementById('registration-form'), appContainer: document.getElementById('app-main-content'), loginForm: document.getElementById('login-form'),
            loginButton: document.getElementById('login-button'), loginButtonText: document.getElementById('login-button-text'), loginSpinner: document.getElementById('login-spinner'),
            loginMessageBox: document.getElementById('login-message-box'), regForm: document.getElementById('reg-form'), regMessageBox: document.getElementById('reg-message-box'),
            navButtons: document.querySelectorAll('.app-header__nav .nav-btn'), logoutButton: document.getElementById('logout-button'), screens: document.querySelectorAll('.screen'),
            lancaForm: document.getElementById('lanca-form'), lancaDateInput: document.getElementById('lanca-date'), lancaMessageBox: document.getElementById('lanca-message-box'),
            confirmModal: document.getElementById('lanca-confirm-modal'), modalReviewBox: document.getElementById('lanca-data-review'), modalCancelButton: document.getElementById('modal-cancel-button'),
            modalConfirmButton: document.getElementById('modal-confirm-button'), refreshHistoryButton: document.getElementById('refresh-history-button'), historicoList: document.getElementById('historico-list'),
            historicoLoading: document.getElementById('historico-loading'), historicoEmpty: document.getElementById('historico-empty'), historicoMessageBox: document.getElementById('historico-message-box'),
            rankingContainer: document.getElementById('ranking-container'), rankingLoading: document.getElementById('ranking-loading'), rankingMessageBox: document.getElementById('ranking-message-box'),
            championContainer: document.getElementById('campeao-geral-container'), championDetails: document.getElementById('campeao-geral-details')
        };
        
        // --- Funções Utilitárias ---
        const getLocalDateISO = () => { const date = new Date(); const offset = date.getTimezoneOffset(); return new Date(date.getTime() - (offset * 60 * 1000)).toISOString().split('T')[0]; };
        function displayMessage(message, type, boxElement) { if (!boxElement) return; boxElement.innerHTML = message; boxElement.className = 'message-box'; if (message) { boxElement.classList.add(`message-box--${type}`, 'is-visible'); } }
        function setLoading(isLoading, button, textElement, spinnerElement, defaultText) { button.disabled = isLoading; spinnerElement.classList.toggle('hidden', !isLoading); textElement.textContent = isLoading ? 'Processando...' : defaultText; }
        
        // --- Controle de UI ---
        function toggleView(viewName) {
            DOMElements.loginContainer.classList.add('hidden'); DOMElements.registrationContainer.classList.add('hidden');
            DOMElements.appContainer.classList.add('hidden'); DOMElements.header.style.display = 'none';
            if (viewName === 'login') { DOMElements.loginContainer.classList.remove('hidden'); }
            else if (viewName === 'registration') { DOMElements.registrationContainer.classList.remove('hidden'); }
            else if (viewName === 'app') { DOMElements.appContainer.classList.remove('hidden'); DOMElements.header.style.display = 'flex'; DOMElements.headerEmpresaName.textContent = appState.empresaName; showScreen('lanca'); }
        }
        function showScreen(screenName) {
            DOMElements.screens.forEach(screen => screen.classList.toggle('is-active', screen.id === `screen-${screenName}`));
            DOMElements.navButtons.forEach(button => button.classList.toggle('is-active', button.dataset.screen === screenName));
            if(screenName === 'historico') fetchLaunchHistory();
            if(screenName === 'ranking') fetchRankingData();
        }

        // --- Lógica de Negócio (Firebase) ---
        async function fetchFromMultiPath(collectionName, queryConstraints = []) {
            const paths = [`/artifacts/${appId}/public/data/${collectionName}`, collectionName];
            for (const path of paths) {
                try {
                    const q = query(collection(db, path), ...queryConstraints);
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) return { docs: querySnapshot.docs.map(d => d.data()), errorLink: null };
                } catch (error) {
                    console.error(`Falha ao buscar em '${path}':`, error);
                    if (error.message.includes('index') && error.message.includes('https://')) {
                        const match = error.message.match(/(https:\/\/[^>\s]+)/);
                        if (match) return { docs: [], errorLink: match[1].replace('...', '') };
                    }
                    throw error;
                }
            }
            return { docs: [], errorLink: null };
        }

        async function handleLogin(event) {
            event.preventDefault();
            setLoading(true, DOMElements.loginButton, DOMElements.loginButtonText, DOMElements.loginSpinner, 'Entrar');
            displayMessage('', 'info', DOMElements.loginMessageBox);
            const username = DOMElements.loginForm.username.value.trim();
            const password = DOMElements.loginForm.password.value.trim();
            if (!username || !password) {
                displayMessage("Por favor, preencha usuário e senha.", 'error', DOMElements.loginMessageBox);
                return setLoading(false, DOMElements.loginButton, DOMElements.loginButtonText, DOMElements.loginSpinner, 'Entrar');
            }
            try {
                const { docs } = await fetchFromMultiPath(COLLECTIONS.LOGIN, [where("usuario", "==", username), where("senha", "==", password)]);
                if (docs.length > 0) {
                    appState.userId = username;
                    const companyData = await fetchCompanyData(username);
                    if (companyData) {
                        appState.empresaName = companyData.empresaName;
                        appState.carGoal = companyData.carGoal;
                        appState.managerName = companyData.managerName;
                        toggleView('app');
                    } else { toggleView('registration'); }
                } else { displayMessage("Usuário ou senha inválidos.", 'error', DOMElements.loginMessageBox); }
            } catch (error) {
                console.error("Erro de Login:", error);
                displayMessage("Falha na conexão. Verifique sua internet e a configuração do Firebase.", 'error', DOMElements.loginMessageBox);
            } finally {
                setLoading(false, DOMElements.loginButton, DOMElements.loginButtonText, DOMElements.loginSpinner, 'Entrar');
            }
        }

        async function fetchCompanyData(userId) {
            const paths = [`/artifacts/${appId}/public/data/${COLLECTIONS.REGISTRATION}`, COLLECTIONS.REGISTRATION];
            for (const path of paths) {
                const docRef = doc(db, path, userId);
                const docSnap = await getDoc(docRef).catch(() => null);
                if (docSnap && docSnap.exists()) return docSnap.data();
            }
            return null;
        }

        async function handleRegistration(event) {
            event.preventDefault();
            const registrationData = {
                userId: appState.userId,
                empresaName: document.getElementById('empresaName').value.trim(),
                managerName: document.getElementById('managerName').value.trim(),
                whatsappNumber: document.getElementById('whatsappNumber').value.trim(),
                carGoal: parseInt(document.getElementById('carGoal').value) || 0,
                registrationDate: new Date().toISOString()
            };
            if (!registrationData.empresaName || !registrationData.managerName || !registrationData.whatsappNumber || registrationData.carGoal <= 0) {
                return displayMessage("Preencha todos os campos corretamente.", 'error', DOMElements.regMessageBox);
            }
            displayMessage("Salvando...", 'info', DOMElements.regMessageBox);
            try {
                const path = `/artifacts/${appId}/public/data/${COLLECTIONS.REGISTRATION}`;
                await setDoc(doc(db, path, appState.userId), registrationData);
                appState.empresaName = registrationData.empresaName;
                appState.carGoal = registrationData.carGoal;
                appState.managerName = registrationData.managerName;
                displayMessage("Cadastro salvo! Redirecionando...", 'success', DOMElements.regMessageBox);
                setTimeout(() => toggleView('app'), 1500);
            } catch (error) {
                console.error("Erro ao salvar registro:", error);
                displayMessage(`Erro ao salvar: ${error.message}`, 'error', DOMElements.regMessageBox);
            }
        }
        
        function prepareDailyLaunch(event){
            event.preventDefault();
            if (!DOMElements.lancaForm.checkValidity()) return displayMessage("Preencha todos os campos obrigatórios.", 'error', DOMElements.lancaMessageBox);
            const dataLancamento = new Date(DOMElements.lancaDateInput.value + 'T12:00:00Z').toISOString().split('T')[0];
            appState.dailyLaunchData = {
                dataLancamento,
                timestamp: new Date().toISOString(), userId: appState.userId, empresaName: appState.empresaName, carGoal: appState.carGoal, managerName: appState.managerName,
                produtividadeEntregues: parseInt(document.getElementById('produtividade-entregues').value) || 0,
                ticketMedioMO: parseFloat(document.getElementById('ticket-medio-mo').value) || 0,
                vendaSeguroAbertos: parseInt(document.getElementById('venda-seguro-abertos').value) || 0,
                vendaAgregadaFechados: parseInt(document.getElementById('venda-agregada-fechados').value) || 0,
                estabilidadeFunilaria: parseInt(document.getElementById('estabilidade-funilaria').value) || 0,
                estabilidadePreparacao: parseInt(document.getElementById('estabilidade-preparacao').value) || 0,
                estabilidadePintura: parseInt(document.getElementById('estabilidade-pintura').value) || 0,
                estabilidadeMontagem: parseInt(document.getElementById('estabilidade-montagem').value) || 0,
                estabilidadePolimento: parseInt(document.getElementById('estabilidade-polimento').value) || 0,
            };
            if (appState.dailyLaunchData.vendaAgregadaFechados > appState.dailyLaunchData.vendaSeguroAbertos) return displayMessage("Vendas agregadas não podem ser maiores que carros de seguro abertos.", 'error', DOMElements.lancaMessageBox);
            const reviewHtml = `<p><strong>Empresa:</strong> ${appState.dailyLaunchData.empresaName}</p><p><strong>Data:</strong> ${appState.dailyLaunchData.dataLancamento}</p><hr style="margin:8px 0"><p><strong>Produtividade:</strong> ${appState.dailyLaunchData.produtividadeEntregues}</p><p><strong>Ticket Médio:</strong> R$ ${appState.dailyLaunchData.ticketMedioMO.toFixed(2)}</p><p><strong>Venda Agregada:</strong> ${appState.dailyLaunchData.vendaAgregadaFechados} de ${appState.dailyLaunchData.vendaSeguroAbertos}</p><hr style="margin:8px 0"><p><strong>Estabilidade:</strong> Fun: ${appState.dailyLaunchData.estabilidadeFunilaria} | Prep: ${appState.dailyLaunchData.estabilidadePreparacao} | Pin: ${appState.dailyLaunchData.estabilidadePintura} | Mon: ${appState.dailyLaunchData.estabilidadeMontagem} | Pol: ${appState.dailyLaunchData.estabilidadePolimento}</p>`;
            DOMElements.modalReviewBox.innerHTML = reviewHtml;
            DOMElements.confirmModal.classList.add('is-visible');
        }

        async function saveDailyLaunch(){
            const data = appState.dailyLaunchData;
            const docId = `${data.userId}_${data.dataLancamento}`;
            const path = `/artifacts/${appId}/public/data/${COLLECTIONS.LAUNCHES}`;
            try {
                await setDoc(doc(db, path, docId), data);
                displayMessage(`Lançamento de ${data.dataLancamento} salvo com sucesso!`, 'success', DOMElements.lancaMessageBox);
                DOMElements.lancaForm.reset();
            } catch (error) {
                console.error("Erro ao salvar lançamento:", error);
                displayMessage(`Erro crítico ao salvar: ${error.message}`, 'error', DOMElements.lancaMessageBox);
            } finally {
                DOMElements.confirmModal.classList.remove('is-visible');
            }
        }
        
        async function fetchLaunchHistory() {
            DOMElements.historicoList.innerHTML = '';
            DOMElements.historicoEmpty.classList.add('hidden');
            DOMElements.historicoLoading.classList.remove('hidden');
            displayMessage('', 'info', DOMElements.historicoMessageBox);
            try {
                const { docs, errorLink } = await fetchFromMultiPath(COLLECTIONS.LAUNCHES, [where("userId", "==", appState.userId), orderBy("dataLancamento", "desc")]);
                if (errorLink) {
                    const msg = `<p><strong>ERRO CRÍTICO: ÍNDICE DO FIREBASE FALTANDO</strong></p><p>A consulta de histórico exige um índice. Clique no link para criá-lo:</p><a href="${errorLink}" target="_blank">CRIAR ÍNDICE</a>`;
                    return displayMessage(msg, 'error', DOMElements.historicoMessageBox);
                }
                if (docs.length === 0) {
                    DOMElements.historicoEmpty.classList.remove('hidden');
                } else {
                    docs.forEach(data => {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        item.innerHTML = `<div class="history-item__header"><h3 class="history-item__title">Lançamento: ${data.dataLancamento}</h3><span class="history-item__meta">Produtividade: ${data.produtividadeEntregues} carros</span></div><ul class="history-item__details"><li><strong>Ticket Médio M.O.:</strong> R$ ${data.ticketMedioMO ? data.ticketMedioMO.toFixed(2) : '0.00'}</li><li><strong>Venda Agregada:</strong> ${data.vendaAgregadaFechados || 0} de ${data.vendaSeguroAbertos || 0}</li><li><strong>Estabilidade:</strong> Fun: ${data.estabilidadeFunilaria||0}, Prep: ${data.estabilidadePreparacao||0}, Pin: ${data.estabilidadePintura||0}, Mon: ${data.estabilidadeMontagem||0}, Pol: ${data.estabilidadePolimento||0}</li></ul>`;
                        DOMElements.historicoList.appendChild(item);
                    });
                }
            } catch (error) {
                displayMessage('Falha ao buscar histórico. Verifique a conexão.', 'error', DOMElements.historicoMessageBox);
            } finally {
                DOMElements.historicoLoading.classList.add('hidden');
            }
        }
        
        function handleLogout() {
            appState.userId = null;
            appState.empresaName = '';
            appState.carGoal = 0;
            appState.managerName = '';
            DOMElements.loginForm.reset();
            toggleView('login');
        }

        const calculateCV = (values) => {
            if (values.length < 2) return Infinity;
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            if (mean === 0) return Infinity;
            const variance = values.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / values.length;
            const standardDeviation = Math.sqrt(variance);
            return (standardDeviation / mean) * 100;
        };
        
        async function fetchRankingData() {
            DOMElements.rankingContainer.innerHTML = '';
            DOMElements.championContainer.classList.add('hidden');
            DOMElements.rankingLoading.classList.remove('hidden');
            displayMessage('', 'info', DOMElements.rankingMessageBox);
            try {
                const { docs, errorLink } = await fetchFromMultiPath(COLLECTIONS.LAUNCHES, [orderBy("dataLancamento", "asc")]);
                if (errorLink) {
                    const msg = `<p><strong>ERRO CRÍTICO (ÍNDICE):</strong> Para calcular o ranking, você precisa criar um índice. Clique no link para criar no Firebase:</p><a href="${errorLink}" target="_blank">CRIAR ÍNDICE DE RANKING</a>`;
                    return displayMessage(msg, 'error', DOMElements.rankingMessageBox);
                }
                if (docs.length === 0) return displayMessage("Nenhum lançamento encontrado para calcular o ranking.", 'info', DOMElements.rankingMessageBox);

                const currentMonth = new Date().toISOString().substring(0, 7);
                const aggregatedData = docs.reduce((acc, lanca) => {
                    const userId = lanca.userId;
                    if (!acc[userId]) {
                        acc[userId] = {
                            empresaName: lanca.empresaName, carGoal: lanca.carGoal || 1, managerName: lanca.managerName || 'N/A',
                            produtividadeEntreguesTotal: 0, vendaAgregadaFechadosTotal: 0, vendaSeguroAbertosTotal: 0,
                            ticketMedioMOLast: 0, ticketMedioLastDate: '', estabilidadeHistory: {},
                        };
                        ESTABILIDADE_FIELDS.forEach(field => acc[userId].estabilidadeHistory[field] = []);
                    }
                    const data = acc[userId];
                    data.produtividadeEntreguesTotal += lanca.produtividadeEntregues || 0;
                    data.vendaAgregadaFechadosTotal += lanca.vendaAgregadaFechados || 0;
                    data.vendaSeguroAbertosTotal += lanca.vendaSeguroAbertos || 0;
                    if (lanca.dataLancamento.startsWith(currentMonth) && (!data.ticketMedioLastDate || lanca.dataLancamento > data.ticketMedioLastDate)) {
                        data.ticketMedioMOLast = lanca.ticketMedioMO || 0;
                        data.ticketMedioLastDate = lanca.dataLancamento;
                    }
                    ESTABILIDADE_FIELDS.forEach(field => data.estabilidadeHistory[field].push(lanca[field] || 0));
                    return acc;
                }, {});

                const finalRankingData = Object.entries(aggregatedData).map(([userId, data]) => {
                    const scores = {
                        produtividadeScore: (data.produtividadeEntreguesTotal / data.carGoal) * 100,
                        ticketMedioScore: data.ticketMedioMOLast,
                        vendaAgregadaScore: data.vendaSeguroAbertosTotal > 0 ? (data.vendaAgregadaFechadosTotal / data.vendaSeguroAbertosTotal) * 100 : 0,
                        estabilidadeScores: {}
                    };
                    ESTABILIDADE_FIELDS.forEach(field => scores.estabilidadeScores[field] = calculateCV(data.estabilidadeHistory[field]));
                    return { userId, empresaName: data.empresaName, managerName: data.managerName, ...scores };
                });
                renderRanking(finalRankingData);
            } catch (error) {
                console.error("Erro ao buscar ranking:", error);
                displayMessage('Falha ao buscar dados do ranking. Verifique a conexão.', 'error', DOMElements.rankingMessageBox);
            } finally {
                DOMElements.rankingLoading.classList.add('hidden');
            }
        }

        function renderRanking(data) {
            const container = DOMElements.rankingContainer;
            container.innerHTML = '';
            const weightedWins = data.reduce((acc, item) => ({...acc, [item.userId]: 0}), {});
            const modalities = [
                { title: 'Produtividade', field: 'produtividadeScore', sortDesc: true, format: val => `${val.toFixed(2)}%` },
                { title: 'Ticket Médio M.O.', field: 'ticketMedioScore', sortDesc: true, format: val => `R$ ${val.toFixed(2)}` },
                { title: 'Venda Agregada', field: 'vendaAgregadaScore', sortDesc: true, format: val => `${val.toFixed(2)}%` },
                ...ESTABILIDADE_FIELDS.map(field => ({
                    title: `Estabilidade: ${field.replace('estabilidade', '')}`,
                    field: field, sortDesc: false,
                    isStability: true, format: val => val === Infinity ? 'N/A' : `${val.toFixed(2)}% (CV)`
                }))
            ];

            modalities.forEach(modality => {
                const sorted = [...data].sort((a, b) => {
                    const scoreA = modality.isStability ? a.estabilidadeScores[modality.field] : a[modality.field];
                    const scoreB = modality.isStability ? b.estabilidadeScores[modality.field] : b[modality.field];
                    if (modality.sortDesc) return scoreB - scoreA;
                    if (scoreA === Infinity) return 1;
                    if (scoreB === Infinity) return -1;
                    return scoreA - scoreB;
                }).slice(0, 3);
                
                if (sorted.length > 0) {
                    const winnerScore = modality.isStability ? sorted[0].estabilidadeScores[modality.field] : sorted[0][modality.field];
                    if (winnerScore > 0 && winnerScore !== Infinity) {
                         weightedWins[sorted[0].userId] += MODALITY_WEIGHTS[modality.field];
                    }
                }
                const card = document.createElement('div');
                card.className = 'ranking-card';
                let itemsHtml = '';
                const medals = ['gold', 'silver', 'bronze'];
                sorted.forEach((item, index) => {
                    const score = modality.isStability ? item.estabilidadeScores[modality.field] : item[modality.field];
                    if (score > 0 && score !== Infinity) {
                         itemsHtml += `<div class="ranking-item ranking-item--${medals[index]}"><span class="ranking-item__name">#${index + 1} ${item.empresaName}</span><span class="ranking-item__score">${modality.format(score)}</span></div>`;
                    }
                });
                card.innerHTML = `<h3 class="ranking-card__title">${modality.title} <span class="weight">(Peso: ${MODALITY_WEIGHTS[modality.field]})</span></h3> ${itemsHtml}`;
                if (itemsHtml) container.appendChild(card);
            });
            
            const champion = Object.entries(weightedWins).reduce((champ, [userId, score]) => score > champ.score ? { userId, score } : champ, { userId: null, score: 0 });
            if (champion.userId && champion.score > 0) {
                const championData = data.find(item => item.userId === champion.userId);
                DOMElements.championDetails.innerHTML = `<p class="champion-card__company-name">${championData.empresaName}</p><p>Gestor: ${championData.managerName}</p><p>Total de Pontos (Peso): <strong>${champion.score.toFixed(1)}</strong></p>`;
                DOMElements.championContainer.classList.remove('hidden');
            }
        }
        
        // --- Inicialização ---
        function initApp() {
            try {
                const firebaseConfig = firebaseConfigString ? JSON.parse(firebaseConfigString) : {
                    apiKey: "AIzaSyCXNM4mPkpY0fcX1rJxB22Fag0zSFlJsM8", authDomain: "calculadoraautoprime-81551.firebaseapp.com",
                    projectId: "calculadoraautoprime-81551", storageBucket: "calculadoraautoprime-81551.firebasestorage.app",
                    messagingSenderId: "745713515166", appId: "1:745713515166:web:bfc2359c7ceed6dcdd998f",
                    measurementId: "G-407CDSRX48"
                };
                const app = initializeApp(firebaseConfig);
                const analytics = getAnalytics(app);
                db = getFirestore(app);
                auth = getAuth(app);
                
                DOMElements.lancaDateInput.max = getLocalDateISO();
                DOMElements.loginForm.addEventListener('submit', handleLogin);
                DOMElements.regForm.addEventListener('submit', handleRegistration);
                DOMElements.lancaForm.addEventListener('submit', prepareDailyLaunch);
                DOMElements.modalCancelButton.addEventListener('click', () => DOMElements.confirmModal.classList.remove('is-visible'));
                DOMElements.modalConfirmButton.addEventListener('click', saveDailyLaunch);
                DOMElements.logoutButton.addEventListener('click', handleLogout);
                DOMElements.refreshHistoryButton.addEventListener('click', fetchLaunchHistory);
                DOMElements.navButtons.forEach(button => button.addEventListener('click', () => showScreen(button.dataset.screen)));
                
                toggleView('login');
            } catch (e) {
                console.error("Falha crítica ao inicializar Firebase:", e);
                document.body.innerHTML = `<div style="padding:2rem;text-align:center;color:red;"><h1>Erro de Configuração</h1><p>O Firebase não pôde ser iniciado. Verifique o objeto de configuração e o console.</p></div>`;
            }
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>