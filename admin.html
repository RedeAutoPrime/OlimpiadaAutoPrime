<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gest√£o de Empresas e Usu√°rios</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --color-primary: #0F172A; --color-secondary: #1E293B; --color-text-primary: #F8FAFC; --color-accent: #2563EB; --color-background: #F1F5F9; --color-surface: #FFFFFF; --color-border: #CBD5E1; --color-error: #DC2626; --color-success: #16A34A; }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background); color: #333; margin: 0; padding: 2rem; display: flex; flex-direction: column; align-items: center; }
        .container { background-color: var(--color-surface); padding: 2rem; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 800px; }
        h1, h2 { color: var(--color-primary); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .full-width { grid-column: 1 / -1; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        input { width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: 4px; box-sizing: border-box; }
        input:read-only { background-color: #e9ecef; cursor: not-allowed; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; color: white; transition: background-color 0.2s; }
        .btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .btn-primary { background-color: var(--color-primary); }
        .btn-secondary { background-color: var(--color-secondary); }
        .btn-accent { background-color: var(--color-accent); }
        .btn-danger { background-color: var(--color-error); }
        .form-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .item-list { margin-top: 2rem; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--color-border); border-radius: 4px; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 1rem; }
        .item-details span { display: block; }
        .item-actions { display: flex; gap: 0.5rem; }
        .permissions-list { font-size: 0.8em; color: #555; font-style: italic; }
        .message { padding: 1rem; border-radius: 4px; margin-top: 1rem; text-align: center; font-weight: 600; }
        .message--success { background-color: #d1fae5; color: var(--color-success); }
        .message--error { background-color: #fee2e2; color: var(--color-error); }
        fieldset { border: 1px solid var(--color-border); border-radius: 4px; padding: 1rem; margin-top: 1rem; }
        legend { font-weight: 600; padding: 0 0.5rem; }
        .permissions-group { display: flex; flex-wrap: wrap; gap: 1.5rem; }
        .permissions-group div { display: flex; align-items: center; gap: 0.5rem; }
        .hidden { display: none; }
        hr { border: 0; border-top: 1px solid var(--color-border); margin: 2rem 0; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="message-box"></div>
        <h1>Painel de Gest√£o</h1>

        <div id="company-view">
            <h2>Gest√£o de Empresas</h2>
            <form id="company-form">
                <input type="hidden" id="companyId">
                <div class="form-grid">
                    <div class="form-group"><label for="nomeEmpresa">Nome da Empresa</label><input type="text" id="nomeEmpresa" required></div>
                    <div class="form-group"><label for="metaCarros">Meta de Carros</label><input type="number" id="metaCarros" required min="1"></div>
                </div>
                <div class="form-actions">
                    <button type="submit" id="company-submit-btn" class="btn btn-primary">Adicionar Empresa</button>
                    <button type="button" id="company-cancel-btn" class="btn btn-secondary" style="display: none;">Cancelar Edi√ß√£o</button>
                </div>
            </form>
            <div id="company-list" class="item-list"></div>
        </div>

        <div id="user-view" class="hidden">
            <button id="back-to-companies-btn" class="btn btn-secondary" style="margin-bottom: 1rem;">&larr; Voltar para Empresas</button>
            <h2 id="user-view-title">Gerenciar Usu√°rios</h2>
            <form id="user-form">
                <div class="form-grid">
                    <div class="form-group"><label for="personName">Nome da Pessoa:</label><input type="text" id="personName" required></div>
                    <div class="form-group"><label for="cargo">Cargo:</label><input type="text" id="cargo" required></div>
                    <div class="form-group"><label for="login">Login (somente n√∫meros):</label><input type="text" id="login" required pattern="[0-9]+"></div>
                    <div class="form-group"><label for="password">Senha (deixe em branco para n√£o alterar):</label><input type="password" id="password" pattern="[0-9]+"></div>
                    <div class="form-group full-width"><label for="whatsapp">WhatsApp (com DDD):</label><input type="tel" id="whatsapp" required pattern="[0-9]{10,11}"></div>
                </div>
                
                <fieldset>
                    <legend>Tipo de Usu√°rio</legend>
                    <div class="permissions-group">
                        <div><input type="checkbox" id="isMaster"><label for="isMaster">üëë Usu√°rio Master (v√™ todo o hist√≥rico da empresa)</label></div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Permiss√µes de Lan√ßamento</legend>
                    <div class="permissions-group">
                        <div><input type="checkbox" id="perm-produtividade"><label for="perm-produtividade">Produtividade</label></div>
                        <div><input type="checkbox" id="perm-ticketMedio"><label for="perm-ticketMedio">Ticket M√©dio</label></div>
                        <div><input type="checkbox" id="perm-vendaAgregada"><label for="perm-vendaAgregada">Venda Agregada</label></div>
                        <div><input type="checkbox" id="perm-estabilidade"><label for="perm-estabilidade">Estabilidade</label></div>
                    </div>
                </fieldset>

                <div class="form-actions">
                    <button type="submit" id="user-submit-btn" class="btn btn-primary">Adicionar Usu√°rio</button>
                    <button type="button" id="user-cancel-btn" class="btn btn-secondary" style="display: none;">Cancelar Edi√ß√£o</button>
                </div>
            </form>
            <div id="user-list-for-company" class="item-list"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc, getDoc, addDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA8Esglzu0IlyTfTeC9tt6to2CyTlXhkV4",
            authDomain: "olimpiedaautoprime-1f4ac.firebaseapp.com",
            projectId: "olimpiedaautoprime-1f4ac",
            storageBucket: "olimpiedaautoprime-1f4ac.firebasestorage.app",
            messagingSenderId: "866395369069",
            appId: "1:866395369069:web:daa97d36bccdd9822d5964",
            measurementId: "G-M6WKSM7PCT"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let currentCompany = { id: null, name: null };

        const DOMElements = {
            messageBox: document.getElementById('message-box'),
            companyView: document.getElementById('company-view'),
            userView: document.getElementById('user-view'),
            companyForm: document.getElementById('company-form'),
            companyIdInput: document.getElementById('companyId'),
            companySubmitBtn: document.getElementById('company-submit-btn'),
            companyCancelBtn: document.getElementById('company-cancel-btn'),
            companyList: document.getElementById('company-list'),
            userViewTitle: document.getElementById('user-view-title'),
            userForm: document.getElementById('user-form'),
            userSubmitBtn: document.getElementById('user-submit-btn'),
            userCancelBtn: document.getElementById('user-cancel-btn'),
            userListForCompany: document.getElementById('user-list-for-company'),
            backToCompaniesBtn: document.getElementById('back-to-companies-btn'),
        };

        const showMessage = (text, type) => {
            DOMElements.messageBox.innerHTML = `<div class="message message--${type}">${text}</div>`;
            setTimeout(() => DOMElements.messageBox.innerHTML = '', 4000);
        };

        const showView = (viewName) => {
            DOMElements.companyView.classList.toggle('hidden', viewName !== 'company');
            DOMElements.userView.classList.toggle('hidden', viewName !== 'user');
        };

        const resetCompanyForm = () => {
            DOMElements.companyForm.reset();
            DOMElements.companyIdInput.value = '';
            DOMElements.companySubmitBtn.textContent = 'Adicionar Empresa';
            DOMElements.companyCancelBtn.style.display = 'none';
        };

        const loadCompanyIntoForm = (company) => {
            DOMElements.companyIdInput.value = company.id;
            DOMElements.companyForm.nomeEmpresa.value = company.nomeEmpresa;
            DOMElements.companyForm.metaCarros.value = company.metaCarros;
            DOMElements.companySubmitBtn.textContent = 'Salvar Altera√ß√µes';
            DOMElements.companyCancelBtn.style.display = 'inline-flex';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        const fetchCompanies = async () => {
            DOMElements.companyList.innerHTML = 'Carregando empresas...';
            try {
                const snapshot = await getDocs(collection(db, 'empresas'));
                DOMElements.companyList.innerHTML = snapshot.empty ? '<p>Nenhuma empresa cadastrada.</p>' : '';
                snapshot.forEach(doc => {
                    const company = { id: doc.id, ...doc.data() };
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'list-item';
                    itemDiv.innerHTML = `<div class="item-details"><span><strong>${company.nomeEmpresa}</strong></span><span>Meta: ${company.metaCarros} carros</span></div>`;
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'item-actions';
                    
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Editar';
                    editBtn.className = 'btn btn-secondary';
                    editBtn.onclick = () => loadCompanyIntoForm(company);

                    const manageUsersBtn = document.createElement('button');
                    manageUsersBtn.textContent = 'Gerenciar Usu√°rios';
                    manageUsersBtn.className = 'btn btn-accent';
                    manageUsersBtn.onclick = () => manageUsersFor(company.id, company.nomeEmpresa);

                    actionsDiv.appendChild(editBtn);
                    actionsDiv.appendChild(manageUsersBtn);
                    itemDiv.appendChild(actionsDiv);
                    DOMElements.companyList.appendChild(itemDiv);
                });
            } catch (error) {
                DOMElements.companyList.innerHTML = `<div class="message message--error">Falha ao carregar empresas: ${error.message}</div>`;
            }
        };

        const resetUserForm = () => {
            DOMElements.userForm.reset();
            DOMElements.userSubmitBtn.textContent = 'Adicionar Usu√°rio';
            DOMElements.userForm.login.readOnly = false;
            DOMElements.userCancelBtn.style.display = 'none';
        };
        
        const fetchUsersForCompany = async () => {
            DOMElements.userListForCompany.innerHTML = 'Carregando usu√°rios...';
            try {
                const q = query(collection(db, 'usuarios'), where("empresaId", "==", currentCompany.id));
                const snapshot = await getDocs(q);
                DOMElements.userListForCompany.innerHTML = snapshot.empty ? '<p>Nenhum usu√°rio para esta empresa.</p>' : '';
                snapshot.forEach(doc => {
                    const user = { id: doc.id, ...doc.data() };
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'list-item';
                    
                    const granted = user.permissions ? Object.entries(user.permissions).filter(([,v])=>v).map(([k])=>k).join(', ') : 'Nenhuma';
                    const masterBadge = user.isMaster ? ' üëë' : '';

                    const userDetails = document.createElement('div');
                    userDetails.className = 'user-details';
                    userDetails.innerHTML = `<span><strong>${user.personName}${masterBadge}</strong> (${user.login})</span><span class="permissions-list">Permiss√µes: ${granted}</span>`;
                    
                    const userActions = document.createElement('div');
                    userActions.className = 'user-actions';

                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Editar';
                    editBtn.className = 'btn btn-secondary';
                    editBtn.onclick = () => loadUserIntoForm(user);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Excluir';
                    deleteBtn.className = 'btn btn-danger';
                    deleteBtn.onclick = async () => {
                        if (confirm(`Excluir o usu√°rio ${user.personName}?`)) {
                            await deleteDoc(doc(db, 'usuarios', user.id));
                            showMessage('Usu√°rio exclu√≠do!', 'success');
                            fetchUsersForCompany();
                        }
                    };

                    userActions.appendChild(editBtn);
                    userActions.appendChild(deleteBtn);
                    itemDiv.appendChild(userDetails);
                    itemDiv.appendChild(userActions);
                    DOMElements.userListForCompany.appendChild(itemDiv);
                });
            } catch (error) {
                DOMElements.userListForCompany.innerHTML = `<div class="message message--error">Falha ao carregar usu√°rios: ${error.message}</div>`;
            }
        };

        const manageUsersFor = (companyId, companyName) => {
            currentCompany = { id: companyId, name: companyName };
            DOMElements.userViewTitle.textContent = `Gerenciando Usu√°rios da ${companyName}`;
            resetUserForm();
            fetchUsersForCompany();
            showView('user');
        };

        const loadUserIntoForm = (user) => {
            resetUserForm();
            DOMElements.userForm.personName.value = user.personName || '';
            DOMElements.userForm.cargo.value = user.cargo || '';
            DOMElements.userForm.login.value = user.login || '';
            DOMElements.userForm.whatsapp.value = user.whatsapp || '';
            DOMElements.userForm.password.value = '';
            
            DOMElements.userForm.isMaster.checked = user.isMaster || false;

            if (user.permissions) {
                DOMElements.userForm['perm-produtividade'].checked = user.permissions.produtividade || false;
                DOMElements.userForm['perm-ticketMedio'].checked = user.permissions.ticketMedio || false;
                DOMElements.userForm['perm-vendaAgregada'].checked = user.permissions.vendaAgregada || false;
                DOMElements.userForm['perm-estabilidade'].checked = user.permissions.estabilidade || false;
            }

            DOMElements.userForm.login.readOnly = true;
            DOMElements.userSubmitBtn.textContent = 'Salvar Altera√ß√µes';
            DOMElements.userCancelBtn.style.display = 'inline-flex';
            window.scrollTo({ top: DOMElements.userViewTitle.offsetTop - 20, behavior: 'smooth' });
        };

        DOMElements.companyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const companyId = DOMElements.companyIdInput.value;
            const companyData = {
                nomeEmpresa: DOMElements.companyForm.nomeEmpresa.value,
                metaCarros: parseInt(DOMElements.companyForm.metaCarros.value),
            };

            try {
                if (companyId) {
                    await setDoc(doc(db, 'empresas', companyId), companyData, { merge: true });
                    showMessage('Empresa atualizada com sucesso!', 'success');
                } else {
                    await addDoc(collection(db, 'empresas'), { ...companyData, dataCadastro: new Date().toISOString() });
                    showMessage('Empresa cadastrada com sucesso!', 'success');
                }
                resetCompanyForm();
                fetchCompanies();
            } catch (error) {
                showMessage(`Erro ao salvar empresa: ${error.message}`, 'error');
            }
        });

        DOMElements.userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const login = DOMElements.userForm.login.value;
            const password = DOMElements.userForm.password.value;
            
            const isEditing = DOMElements.userForm.login.readOnly;
            const docRef = doc(db, 'usuarios', login);

            const userData = {
                empresaId: currentCompany.id,
                login: login,
                personName: DOMElements.userForm.personName.value,
                cargo: DOMElements.userForm.cargo.value,
                whatsapp: DOMElements.userForm.whatsapp.value,
                isMaster: DOMElements.userForm.isMaster.checked,
                permissions: {
                    produtividade: DOMElements.userForm['perm-produtividade'].checked,
                    ticketMedio: DOMElements.userForm['perm-ticketMedio'].checked,
                    vendaAgregada: DOMElements.userForm['perm-vendaAgregada'].checked,
                    estabilidade: DOMElements.userForm['perm-estabilidade'].checked,
                }
            };

            if (password) {
                userData.senhaHash = CryptoJS.SHA256(password).toString();
            } else if (!isEditing) {
                return showMessage('Senha √© obrigat√≥ria para novos usu√°rios.', 'error');
            }
            
            try {
                await setDoc(docRef, userData, { merge: true });
                showMessage(`Usu√°rio ${isEditing ? 'atualizado' : 'adicionado'} com sucesso!`, 'success');
                resetUserForm();
                fetchUsersForCompany();
            } catch (error) {
                showMessage(`Erro ao salvar usu√°rio: ${error.message}`, 'error');
            }
        });
        
        DOMElements.companyCancelBtn.addEventListener('click', resetCompanyForm);
        DOMElements.userCancelBtn.addEventListener('click', resetUserForm);
        DOMElements.backToCompaniesBtn.addEventListener('click', () => showView('company'));

        fetchCompanies();
        showView('company');
    </script>
</body>
</html>